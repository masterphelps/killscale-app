#!/usr/bin/env node
import {writeFileSync} from 'fs';
import {join} from 'path';
import {top250} from './top-250-google-fonts.js';
import {execSync} from 'child_process';
import type {FontInfo} from '@remotion/google-fonts';
import type {GoogleFont} from '@remotion/google-fonts';

interface MinimalFontInfo {
  importName: string;
  fontFamily: string;
  previewUrl: string;
}

async function generateFontInfo() {
  console.log('ðŸš€ Starting Google Fonts data generation...');

  const googleFonts: FontInfo[] = [];
  const basicInfos: MinimalFontInfo[] = [];
  let successCount = 0;
  let errorCount = 0;

  console.log(`\nðŸ“¦ Loading ${top250.length} font modules...`);

  for (const font of top250) {
    try {
      // Load the font module dynamically
      const fontModule = (await font.load()) as GoogleFont;

      // Extract the FontInfo using getInfo()
      const fontInfo = fontModule.getInfo();

      // Add to full database
      googleFonts.push(fontInfo);

      // Extract basic info for browser list
      // The preview URL is extracted from the full Google Fonts URL
      const previewUrl =
        fontInfo.url.match(/family=([^:]+):/)?.[1] ||
        font.family.replace(/\s+/g, '+');

      basicInfos.push({
        importName: fontInfo.importName,
        fontFamily: fontInfo.fontFamily,
        previewUrl: previewUrl,
      });

      successCount++;
      console.log(
        `âœ… Loaded ${fontInfo.fontFamily} (${successCount}/${top250.length})`,
      );
    } catch (error) {
      errorCount++;
      console.error(`âŒ Failed to load ${font.family}:`, error);
    }
  }

  console.log(
    `\nðŸ“Š Summary: ${successCount} fonts loaded successfully, ${errorCount} errors`,
  );

  if (googleFonts.length === 0) {
    throw new Error('No fonts were loaded successfully!');
  }

  // Generate google-fonts.ts (full database)
  console.log('\nðŸ“ Generating google-fonts.ts (server-side database)...');
  const serverFileContent = `/**
 * AUTO-GENERATED FILE - DO NOT EDIT MANUALLY
 * Generated by: scripts/generate-google-font-info.ts
 * Generated on: ${new Date().toISOString()}
 * 
 * This file contains complete font metadata for server-side rendering.
 * It includes ${googleFonts.length} Google Fonts with full FontInfo objects.
 * 
 * WARNING: This file is ~50,000 lines and should NEVER be imported in browser code!
 */

import type { FontInfo } from '@remotion/google-fonts';

// Throw error if this file is imported in browser
if (typeof window !== 'undefined') {
  throw new Error(
    'google-fonts.ts should not be imported in browser code! ' +
    'This file is server-only due to its large size (~2MB). ' +
    'Use google-fonts-list.ts for browser-safe font list or /api/fonts/:name endpoint.'
  );
}

/**
 * Complete font metadata for Google Fonts
 * Used for server-side rendering in Remotion
 */
export const GOOGLE_FONTS_DATABASE: FontInfo[] = ${JSON.stringify(googleFonts, null, 2)};
`;

  const serverFilePath = join(__dirname, '..', 'data', 'google-fonts.ts');
  writeFileSync(serverFilePath, serverFileContent, 'utf-8');
  console.log(
    `âœ… Created: ${serverFilePath} (${(serverFileContent.length / 1024 / 1024).toFixed(2)}MB)`,
  );

  // Generate google-fonts-list.ts (browser-safe)
  console.log('\nðŸ“ Generating google-fonts-list.ts (browser-safe list)...');
  const browserFileContent = `/**
 * AUTO-GENERATED FILE - DO NOT EDIT MANUALLY
 * Generated by: scripts/generate-google-font-info.ts
 * Generated on: ${new Date().toISOString()}
 * 
 * This file contains a minimal font list for browser use.
 * For full font metadata, use the /api/fonts/:name endpoint.
 */

/**
 * Minimal font information for browser UI
 * Contains ${basicInfos.length} Google Fonts
 */
export const GOOGLE_FONTS_LIST = ${JSON.stringify(basicInfos, null, 2)};

/**
 * Type definition for font list items
 */
export type GoogleFontListItem = typeof GOOGLE_FONTS_LIST[number];
`;

  const browserFilePath = join(__dirname, '..', 'data', 'google-fonts-list.ts');
  writeFileSync(browserFilePath, browserFileContent, 'utf-8');
  console.log(
    `âœ… Created: ${browserFilePath} (${(browserFileContent.length / 1024).toFixed(2)}KB)`,
  );

  // Format files with Prettier
  console.log('\nðŸŽ¨ Formatting files with Prettier...');
  try {
    execSync(`npx prettier --write "${serverFilePath}" "${browserFilePath}"`, {
      stdio: 'inherit',
    });
    console.log('âœ… Files formatted successfully');
  } catch (error) {
    console.warn(
      'âš ï¸  Prettier formatting failed, but files were generated successfully',
    );
  }

  console.log('\nâœ¨ Font data generation complete!');
  console.log(`   - Server database: ${googleFonts.length} fonts`);
  console.log(`   - Browser list: ${basicInfos.length} fonts`);
}

// Run the generator
generateFontInfo().catch((error) => {
  console.error('\nðŸ’¥ Fatal error:', error);
  process.exit(1);
});